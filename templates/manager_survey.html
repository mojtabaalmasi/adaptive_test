<!-- templates/manager_survey.html -->
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>پرسشنامه مدیر مرکز | آزمون تطبیقی</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
  <!-- آیکون‌ها (اختیاری) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- استایل تکمیلی اختیاری -->
  <style>
    body { background: #f8f9fb; }
    .app-navbar { background: #0d6efd; }
    .app-navbar .navbar-brand, .app-navbar .nav-link, .app-navbar .navbar-text { color: #fff !important; }
    .page-header { margin: 1.25rem 0 1rem; }
    .q-card { transition: box-shadow .2s ease; }
    .q-card:hover { box-shadow: 0 0.75rem 1.5rem rgba(13,110,253,.1); }
    .status-badge { font-size: .8rem; }
    .rec-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #dc3545; margin-inline-start: .5rem; vertical-align: middle; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.2; } }
    .sticky-footer { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #e9ecef; padding: .75rem; }
    .btn-wide { min-width: 180px; }
  </style>
</head>
<body>
  <!-- ناوبری -->
  <nav class="navbar navbar-expand-lg app-navbar">
    <div class="container">
      <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">آزمون تطبیقی IRT</a>
      <span class="navbar-text ms-auto">مدیر: {{ user_name or '---' }}</span>
    </div>
  </nav>

  <!-- بدنه -->
  <main class="container">
    <div class="page-header">
      <h1 class="h4 mb-2">پرسشنامه مدیر مرکز آموزش زبان فارسی</h1>
      <p class="text-muted mb-0">برای هر سؤال، روی «شروع ضبط» بزنید، صحبت کنید و سپس «پایان ضبط» و «ارسال» را بزنید.</p>
    </div>

    {% if questions and questions|length > 0 %}
      <div class="row g-3">
        {% for q in questions %}
        <div class="col-12">
          <div class="card q-card shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start justify-content-between">
                <div>
                  <div class="text-muted small mb-1">سؤال {{ loop.index }}</div>
                  <h2 class="h6 mb-3">{{ q.text }}</h2>
                </div>
                <span class="badge bg-secondary status-badge" data-status>ضبط نشده</span>
              </div>

              <div class="d-flex flex-wrap align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" data-start>
                  <i class="bi bi-mic-fill me-1"></i> شروع ضبط
                </button>
                <button class="btn btn-outline-danger btn-sm" data-stop disabled>
                  <i class="bi bi-stop-fill me-1"></i> پایان ضبط
                </button>
                <button class="btn btn-primary btn-sm btn-wide" data-upload disabled>
                  <i class="bi bi-cloud-arrow-up-fill me-1"></i> ارسال پاسخ صوتی
                </button>
                <span class="text-danger small d-none" data-rec-indicator><span class="rec-dot"></span>در حال ضبط…</span>
                <span class="text-muted small" data-duration></span>
              </div>

              <div class="mt-3">
                <audio class="w-100 d-none" controls data-player></audio>
              </div>

              <div class="mt-2">
                <div class="small text-muted" data-msg>—</div>
              </div>

              <!-- نگهدارنده شناسه سؤال -->
              <input type="hidden" value="{{ q.id }}" data-qid>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="sticky-footer mt-3 d-flex justify-content-between align-items-center">
        <div class="text-muted small">پس از ارسال پاسخ‌ها می‌توانید به آزمون تطبیقی بروید.</div>
        <a href="{{ url_for('test') }}" class="btn btn-success">
          ادامه به آزمون تطبیقی
          <i class="bi bi-arrow-left-short"></i>
        </a>
      </div>
    {% else %}
      <div class="alert alert-info">فعلاً سؤالی برای این پرسشنامه تعریف نشده است.</div>
      <a href="{{ url_for('test') }}" class="btn btn-success">ادامه به آزمون تطبیقی</a>
    {% endif %}
  </main>

  <!-- Bootstrap JS (اختیاری برای برخی تعاملات) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>

  <!-- اسکریپت ضبط و آپلود -->
  <script>
    let sharedStream = null;

    async function getStream() {
      if (!sharedStream) {
        sharedStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      }
      return sharedStream;
    }

    function fmtSec(sec) {
      if (!isFinite(sec) || sec <= 0) return '';
      return `~ ${sec.toFixed(1)} ثانیه`;
    }

    document.querySelectorAll('[data-qid]').forEach((holder) => {
      const cardBody = holder.closest('.card-body');

      const qid = holder.value;
      const btnStart = cardBody.querySelector('[data-start]');
      const btnStop = cardBody.querySelector('[data-stop]');
      const btnUpload = cardBody.querySelector('[data-upload]');
      const player = cardBody.querySelector('[data-player]');
      const msg = cardBody.querySelector('[data-msg]');
      const statusBadge = cardBody.querySelector('[data-status]');
      const recIndicator = cardBody.querySelector('[data-rec-indicator]');
      const durEl = cardBody.querySelector('[data-duration]');

      let recorder = null;
      let chunks = [];
      let blob = null;
      let startTs = null;

      btnStart.addEventListener('click', async () => {
        try {
          const stream = await getStream();
          chunks = [];
          blob = null;
          startTs = Date.now();
          // تلاش برای webm؛ مرورگر خودش تصمیم می‌گیرد
          recorder = new MediaRecorder(stream);
          recorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
          recorder.onstop = () => {
            const durMs = Date.now() - startTs;
            blob = new Blob(chunks, { type: recorder.mimeType || 'audio/webm' });
            const url = URL.createObjectURL(blob);
            player.src = url;
            player.classList.remove('d-none');
            player.load();
            durEl.textContent = fmtSec(durMs / 1000);
            btnUpload.disabled = false;
            statusBadge.className = 'badge bg-warning text-dark status-badge';
            statusBadge.textContent = 'آماده ارسال';
            recIndicator.classList.add('d-none');
            msg.textContent = 'فایل آماده‌ی ارسال است.';
          };
          recorder.start();
          btnStart.disabled = true;
          btnStop.disabled = false;
          btnUpload.disabled = true;
          statusBadge.className = 'badge bg-danger status-badge';
          statusBadge.textContent = 'در حال ضبط';
          recIndicator.classList.remove('d-none');
          msg.textContent = 'در حال ضبط…';
        } catch (e) {
          console.error(e);
          msg.textContent = 'دسترسی به میکروفون ممکن نیست. روی دستگاه موبایل/HTTPS تست کنید.';
        }
      });

      btnStop.addEventListener('click', () => {
        if (recorder && recorder.state === 'recording') {
          recorder.stop();
          btnStart.disabled = false;
          btnStop.disabled = true;
        }
      });

      btnUpload.addEventListener('click', async () => {
        if (!blob) return;
        btnUpload.disabled = true;
        statusBadge.className = 'badge bg-secondary status-badge';
        statusBadge.textContent = 'در حال ارسال…';
        msg.textContent = 'در حال ارسال…';

        const mime = blob.type || 'audio/webm';
        const file = new File([blob], 'answer.webm', { type: mime });
        const form = new FormData();
        form.append('audio', file);
        form.append('question_id', qid);
        // تلاش برای گرفتن مدت از پلیر
        const durMs = (player.duration && isFinite(player.duration)) ? Math.round(player.duration * 1000) : '';
        form.append('duration_ms', durMs);

        try {
          const res = await fetch('{{ url_for("api_voice_answer") }}', { method: 'POST', body: form });
          const j = await res.json();
          if (j.ok) {
            statusBadge.className = 'badge bg-success status-badge';
            statusBadge.textContent = 'ارسال شد';
            msg.textContent = 'پاسخ صوتی ثبت شد.';
          } else {
            statusBadge.className = 'badge bg-danger status-badge';
            statusBadge.textContent = 'خطا';
            msg.textContent = 'خطا در ارسال: ' + (j.error || res.status);
            btnUpload.disabled = false;
          }
        } catch (e) {
          console.error(e);
          statusBadge.className = 'badge bg-danger status-badge';
          statusBadge.textContent = 'خطای شبکه';
          msg.textContent = 'خطای شبکه.';
          btnUpload.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
